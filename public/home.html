<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç™»å…¥å¾Œé é¢</title>

  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7f9;--card:#ffffff;--text:#1f2937;--muted:#e0e7ff;--primary:#0B1746;--border:#3152be;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"}
    .app{display:grid;grid-template-columns:260px 1fr;min-height:100vh}

    /* ===== Sidebar å·¦å´å€å¡Š ===== */
    .sidebar{background:var(--primary);display:flex;flex-direction:column;color:#fff}
    .account{padding:20px 16px;border-bottom:1px solid rgba(255,255,255,.2);display:flex;align-items:center;justify-content:space-between}
    .account .name{font-weight:700;font-size:30px}
    .account .role{color:rgba(255,255,255,.8);font-size:12px;margin-top:4px}
    .logout-btn{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,.6);background:transparent;cursor:pointer;font-size:13px;color:#fff}

    .nav{padding:0;margin:0;list-style:none;flex:1;display:flex;flex-direction:column}
    .nav li{margin:0}
    .nav button{width:100%;font-size:15px;text-align:left;padding:14px;margin:0;border:none;border-bottom:1px solid rgba(255,255,255,.2);background:#fff;color:#1f2937;cursor:pointer;transition:.15s ease}
    .nav button:hover{background:#f3f4f6}
    .nav button.active{background:#e0e7ff;color:#1e3a8a;font-weight:600;font-size: 18px}

    /* ===== Main å³å´å€å¡Š ===== */
    .main{display:flex;flex-direction:column;}
    .topbar{height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;border-bottom:1px solid #e5e7eb;background:#fff;position:sticky;top:0}
    .topbar .title{font-weight:700;font-size: 25px;}
    .content{padding:24px;}

    /* å¡ç‰‡å…±ç”¨æ¨£å¼ */
    .card{background:var(--card);border:1px solid #e5e7eb;border-radius:14px;padding:18px;box-shadow:0 6px 20px rgba(0,0,0,.04)}
    .grid{display:grid;gap:16px}

    /* ===== å°ˆæ¡ˆé€²åº¦å…§çš„è®Šæ•¸ ===== */
    :root{
      --side-stage: 70px;  /* éšæ®µæ¬„å¯¬ */
      --side-id: 100px;    /* ç·¨è™Ÿæ¬„å¯¬ */
      --side-name: 200px;  /* æ¡ˆåæ¬„å¯¬ */
      --cols: 8;           /* å›ºå®š 8 å€‹æ­¥é©Ÿ */
      --action-col: 36px;  /* æ¯å€‹åœ–ç¤ºæ¬„å¯¬ */
      --cell-min: 110px;   /* æ¯æ ¼æœ€å°å¯¬åº¦ */
      --gap: 10px;

      /* é¡è‰²ç›¸é—œ */
      --line: #e5e7eb;
      --muted: #6b7280;
      --ok-bg: #f3f4f6; --ok-bd: #d1d5db; --ok-fg: #111827;
      --wait: #1d4ed8; --design: #059669; --build: #dc2626;
      --warn-bg: #fff7ed; --warn-bd: #f59e0b; --warn-fg: #b45309;   /* é»ƒç‡ˆ */
      --danger-bg: #fee2e2; --danger-bd: #ef4444; --danger-fg: #991b1b; /* ç´…ç‡ˆ */
      --done-bg: #ecfdf5; --done-bd: #10b981; --done-fg: #065f46;   /* ç¶ ç‡ˆ */
      --shadow: 0 6px 20px rgba(0,0,0,.08); --radius: 12px;
    }

    /* === é ç°½ç¨ç«‹ä¸€åˆ—ï¼ˆä¸è·Ÿ legend åŒåˆ—ï¼‰ === */
    .tabs-row{
      display:flex; gap:8px; align-items:flex-end;
      border-bottom:1px solid var(--line);
      padding:6px 0 0; margin:0 0 10px;
    }
    .tabs-row .tab{
      padding:1px 15px; border:none; background:#ffffff; cursor:pointer;
      font-weight:700; color:#000000; font-size:18px; border-radius:10px 10px 0 0;
    }
    .tabs-row .tab[aria-selected="true"]{
      color:var(--primary);
      color:#ffffff; 
      background:#000000;
      border:1px solid var(--line);
      border-bottom-color:#000000; /* èˆ‡å…§å®¹ç›¸é€£çš„ç¶“å…¸ Tab å¤–è§€ */
    }
    .tabs-row .tab:focus{ outline:2px solid #c7d2fe; outline-offset:2px; }


    /* ===== è¡¨é ­ï¼ˆåŒ…å« 3 + 8 + 3 æ¬„ï¼‰ ===== */
    .grid-header{
      display:grid;
      grid-template-columns:
        var(--side-stage) var(--side-id) var(--side-name)
        repeat(var(--cols), minmax(var(--cell-min), 1fr))
        repeat(3, var(--action-col)); /* æ–°å¢ 3 æ¬„ */
      column-gap: var(--gap);
      align-items:center;
      font-size:13px; color:var(--muted);
      padding: 8px 12px; border-bottom:1px solid var(--line);
    }
    .grid-header div{ text-align:center; }
    .grid-header div:nth-child(1),
    .grid-header div:nth-child(2),
    .grid-header div:nth-child(3){ text-align:left; }
    /* æœ€å¾Œ 3 æ ¼ç•™ç™½ä¸ç•«åº•è‰²/é‚Šæ¡† */
    .grid-header .action-head{ background:transparent; border:none; }


    /* ===== æ¯ä¸€åˆ—ï¼ˆåŒ…å« éšæ®µ + 8 + 3 æ¬„ï¼‰ ===== */
    .project-row{
      display:grid;
      grid-template-columns:
        var(--side-stage) var(--side-id) var(--side-name)
        repeat(var(--cols), minmax(var(--cell-min), 1fr))
        repeat(3, var(--action-col)); /* æ–°å¢ 3 æ¬„ */
      column-gap: var(--gap);
      align-items:center;
      padding: 10px 12px; border-bottom:1px dashed var(--line);
    }

    .cell-id{ font-weight:600; }
    .cell-name{ font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .cell-stage select{
      width: 100%; padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#fff; font-size:14px;
    }

    /* å·²å®Œæˆé ç°½ç”¨ï¼šåœ¨ã€Œéšæ®µã€æ¬„é¡¯ç¤ºçš„å›ºå®šå…§å®¹ */
    .cell-stage .badge-done{
      display:flex; 
      align-items:center; 
      justify-content:center;
      height:35px;             
      border-radius: var(--radius);
      border:1px dashed var(--done-bd);
      background: var(--done-bg);
      color: var(--done-fg);
      font-weight:700;
      font-size:14px;
    }


    /* ===== ä»»å‹™æ ¼å­ï¼ˆç´… / é»ƒ / ç¶  ç‡ˆæ¨£å¼é½Šå…¨ï¼‰ ===== */
    .task-cell{
      height: 44px; border-radius: var(--radius);
      border:1px dashed var(--ok-bd); background: var(--ok-bg); color: var(--ok-fg);
      display:flex; align-items:center; justify-content:center;
      font-size:14px; font-weight:600;
      transition: transform .15s ease, box-shadow .15s ease;
    }
    .task-cell:hover{ transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.06); }
    .task-cell[data-state="warn"]{ background: var(--warn-bg); border-color: var(--warn-bd); color: var(--warn-fg); }   /* é»ƒç‡ˆ */
    .task-cell[data-state="danger"]{ background: var(--danger-bg); border-color: var(--danger-bd); color: var(--danger-fg); } /* ç´…ç‡ˆ */
    .task-cell[data-state="done"]{ background: var(--done-bg); border-color: var(--done-bd); color: var(--done-fg); }   /* ç¶ ç‡ˆ */

    /* ===== åˆ—é¡è‰² by stage ===== */
    .status-waiting .cell-id, .status-waiting .cell-name{ color: var(--wait); }
    .status-design  .cell-id, .status-design  .cell-name{ color: var(--design); }
    .status-build   .cell-id, .status-build   .cell-name{ color: var(--build); }
    .is-done        .cell-id, .is-done        .cell-name{ color: #000 !important;}

    /* ===== å·¥å…·åˆ— & åœ–ä¾‹ï¼ˆç´…é»ƒç¶ ç‡ˆï¼‰ ===== */
    .card-topbar{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:10px; }
    .legend{ display:flex; gap:16px; align-items:center; font-size:13px; color:var(--muted); }
    .function-buttons{ display:flex; gap:10px; margin-left:auto; }
    .pill{ display:inline-flex; align-items:center; gap:8px; padding:4px 10px; border-radius:999px; border:1px solid var(--line); background:#fff; }
    .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
    .dot.ok{ background:#9ca3af; }       /* ä¸€èˆ¬ */
    .dot.warn{ background:#f59e0b; }     /* é»ƒç‡ˆ */
    .dot.danger{ background:#ef4444; }   /* ç´…ç‡ˆ */
    .dot.done{ background:#10b981; }     /* ç¶ ç‡ˆ */

    @media (max-width: 640px){
      .card-topbar{ flex-wrap:wrap; }
      .function-buttons{ margin-left:0; }
    }

    /* Emoji å‹•ä½œæŒ‰éˆ•æ¨£å¼ */
    .action-btn{
      display:flex;align-items:center;justify-content:center;
      height:32px;width:32px;border-radius:8px;
      border:1px solid var(--ok-bd, #d1d5db);
      background:#fff;cursor:pointer;
      transition: transform .05s ease, box-shadow .2s ease, background .2s ease;
      font-size:18px; line-height:1; padding:0; /* è®“ emoji ç½®ä¸­ */
    }
    .action-btn:hover{ box-shadow:0 2px 6px rgba(0,0,0,.08) }
    .action-btn:active{ transform: translateY(1px) }
    .action-btn[disabled]{ opacity:.5; pointer-events:none }


    /* Modal æ¨£å¼ */
    .modal-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:none;align-items:center;justify-content:center;z-index:1000;
    }
    .modal{
      background:#fff;width:560px;max-width:95vw;border-radius:14px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);padding:18px 18px 16px;
      animation:modalIn .15s ease-out;
    }
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .modal-title{font-weight:700;font-size:18px;margin:0}
    .modal-close{border:none;background:transparent;font-size:24px;cursor:pointer;line-height:1}
    .modal-body{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .modal-actions{grid-column:1 / -1;display:flex;gap:8px;justify-content:flex-end;margin-top:4px}
    @keyframes modalIn{from{opacity:0;transform:translateY(4px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
    .modal input,.modal select{
      width:100%;padding:8px;border:1px solid #e5e7eb;border-radius:10px;font-size:14px
    }
    #f_due_preview{grid-column:1 / -1;font-size:13px;color:#6b7280;margin-top:4px}

    /* é ç°½éƒ½æœ‰éšæ®µ ç·¨è™Ÿ æ¡ˆå */
    .grid-header,
    .grid-header.mode-default,
    .grid-header.mode-done{
      display:grid;
      grid-template-columns:
        var(--side-stage) var(--side-id) var(--side-name)
        repeat(var(--cols), minmax(var(--cell-min), 1fr))
        repeat(3, var(--action-col));
    }

    .project-row,
    .project-row.mode-default,
    .project-row.mode-done{
      display:grid;
      grid-template-columns:
        var(--side-stage) var(--side-id) var(--side-name)
        repeat(var(--cols), minmax(var(--cell-min), 1fr))
        repeat(3, var(--action-col));
    }

  </style>
</head>
<body>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <div class="app">
    <!-- å·¦å´ Sidebarï¼šå¸³è™Ÿã€ç™»å‡ºã€é¸å–® -->
    <aside class="sidebar">
      <div class="account">
        <div>
          <div class="name" id="accountName">ä½¿ç”¨è€…åç¨±</div>
          <div class="role" id="accountRole">å·²ç™»å…¥</div>
        </div>
        <button id="logoutBtn" class="logout-btn">ç™»å‡º</button>
      </div>
      <ul class="nav">
        <li><button class="active" data-view="projects">å°ˆæ¡ˆé€²åº¦</button></li>
        <li><button data-view="password">ä¿®æ”¹å¯†ç¢¼</button></li>
      </ul>
    </aside>

    <!-- å³å´ Main -->
    <main class="main">
      <!-- é é¢é ‚ç«¯æ¨™é¡Œåˆ— -->
      <div class="topbar">
        <div class="title" id="pageTitle">æ‰€æœ‰å°ˆæ¡ˆé€²åº¦</div>
      </div>

      <section class="content">
        <!-- å°ˆæ¡ˆé€²åº¦ View -->
        <div id="view-projects" class="view">
          <div class="card">

            <!-- é ç°½ï¼šé€²è¡Œä¸­ï¼å·²å®Œæˆï¼å…¨éƒ¨ -->
            <div class="tabs-row" role="tablist" aria-label="å°ˆæ¡ˆç¯©é¸">
              <button class="tab" role="tab" data-filter="ongoing" aria-selected="true">é€²è¡Œä¸­</button>
              <button class="tab" role="tab" data-filter="done" aria-selected="false">å·²å®Œæˆ</button>
              <button class="tab" role="tab" data-filter="all" aria-selected="false">å…¨éƒ¨</button>
            </div>

            <!-- å·¥å…·åˆ—ï¼šå·¦ç‹€æ…‹èªªæ˜ + å³åŠŸèƒ½æŒ‰éˆ• -->
            <div class="card-topbar">

              <div class="legend" id="legendBar">
                <span class="pill"><i class="dot ok"></i>æ­£å¸¸</span>
                <span class="pill"><i class="dot warn"></i>è¼•å¾®è¶…æ™‚</span>
                <span class="pill"><i class="dot danger"></i>è¶…æ™‚7å¤©</span>
                <span class="pill"><i class="dot done"></i>å®Œæˆ(ä¸Šå‚³ç…§ç‰‡)</span>
              </div>
              <div class="function-buttons" style="flex-direction: column; align-items: flex-end;">
                <div id="unsavedNotice" style="display:none;color:#b45309;font-weight:600;margin-bottom:4px;">
                  âš ï¸ å°šæœªå„²å­˜ä¿®æ”¹ï¼Œè«‹è¨˜å¾—æŒ‰ä¸‹ã€Œå„²å­˜ã€
                </div>
                <div>
                  <button id="addProjectBtn"
                          style="padding:6px 12px;border:1px solid var(--primary);background:#fff;color:var(--primary);border-radius:8px;cursor:pointer">
                    æ–°å¢
                  </button>
                  <button id="saveBtn"
                          style="padding:6px 12px;border:1px solid var(--primary);background:var(--primary);color:#fff;border-radius:8px;cursor:pointer">
                    å„²å­˜
                  </button>
                </div>
              </div>
            </div>

            <!-- Grid è¡¨é ­ -->
            <div class="grid-header mode-default" id="gridHeader">
              <div>éšæ®µ</div>
              <div>ç·¨è™Ÿ</div>
              <div>æ¡ˆå</div>
              <!--  8 æ¬„ä½çš„è¡¨é ­åç¨±
              <div>ä¸ˆé‡</div>
              <div>æ¡ˆä¾‹åˆ†æ</div>
              <div>å¹³é¢æ”¾æ¨£</div>
              <div>å¹³é¢åœ–</div>
              <div>å¹³é¢ç³»çµ±åœ–</div>
              <div>ç«‹é¢æ¡†é«”åœ–</div>
              <div>ç«‹é¢åœ–</div>
              <div>æ–½å·¥åœ–</div> -->
              <div class="action-head"></div>
              <div class="action-head"></div>
              <div class="action-head"></div>
            </div>

            <!-- ç”±ç¨‹å¼å‹•æ…‹æ³¨å…¥ -->
            <div id="projectsGrid"></div>
          </div>
        </div>

        <!-- ä¿®æ”¹å¯†ç¢¼ Viewï¼ˆä¿æŒåŸæ¨£ï¼‰ -->
        <div id="view-password" class="view" style="display:none">
          <div class="card" style="max-width:520px">
            <h2 style="margin:0 0 8px">ä¿®æ”¹å¯†ç¢¼</h2>
            <p style="margin:0 16px 16px 0;color:#6b7280">è«‹è¼¸å…¥èˆŠå¯†ç¢¼èˆ‡æ–°å¯†ç¢¼ã€‚</p>
            <form id="pwdForm" onsubmit="return false;">
              <div style="display:grid;gap:12px">
                <label>
                  <div style="font-size:14px;margin-bottom:4px">èˆŠå¯†ç¢¼</div>
                  <input type="password" id="oldPwd" placeholder="è¼¸å…¥èˆŠå¯†ç¢¼" required style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px">
                </label>
                <label>
                  <div style="font-size:14px;margin-bottom:4px">æ–°å¯†ç¢¼</div>
                  <input type="password" id="newPwd" placeholder="è‡³å°‘ 6 ç¢¼" required minlength="6" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px">
                </label>
                <label>
                  <div style="font-size:14px;margin-bottom:4px">å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼</div>
                  <input type="password" id="newPwd2" placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" required minlength="6" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px">
                </label>
                <button id="savePwd" style="margin-top:6px;padding:10px 14px;border:1px solid var(--primary);background:var(--primary);color:#fff;border-radius:10px;cursor:pointer">å„²å­˜</button>
                <div id="pwdMsg" style="font-size:14px;color:#6b7280"></div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- æ–°å¢/ç·¨è¼¯ å…±ç”¨ Modal  -->
      <div id="createModal" class="modal-overlay">
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title">æ–°å¢å°ˆæ¡ˆ</h3>
            <button id="modalCloseBtn" class="modal-close" aria-label="é—œé–‰">&times;</button>
          </div>
          <div class="modal-body">
            <label>ç·¨è™Ÿï¼ˆå¿…å¡«ï¼‰
              <input id="f_project_id" />
            </label>
            <label>æ¡ˆåï¼ˆå¿…å¡«ï¼‰
              <input id="f_name" />
            </label>
            <label>éšæ®µ
              <select id="f_stage">
                <option value="0">ç­‰å¾…</option>
                <option value="1">è¨­è¨ˆ</option>
                <option value="2">æ–½å·¥</option>
              </select>
            </label>
            <label>é–‹å§‹æ—¥
              <input id="f_start_date" type="date" />
            </label>
            <label>å·¥æœŸå¤©æ•¸
              <input id="f_estimated_days" type="number" min="0" step="1" />
            </label>
            <label>è² è²¬äºº
              <select id="f_responsible_user">
                <option value="">ï¼ˆæœªæŒ‡æ´¾ï¼‰</option>
              </select>
            </label>

            <div id="f_due_preview">é è¨ˆå®Œå·¥æ—¥ï¼šâ€”</div>

            <div class="modal-actions">
              <button id="f_cancel">å–æ¶ˆ</button>
              <button id="f_submit" style="background:var(--primary);color:#fff;border:1px solid var(--primary);padding:8px 12px;border-radius:8px;cursor:pointer">é€å‡º</button>
            </div>
          </div>
        </div>
      </div>
      <!-- /Modal -->
    </main>
  </div>

  <!-- ========= JS ========= -->

  <!-- æ§åˆ¶URLåç¨± è·Ÿç™»å…¥å¾Œçš„ä½¿ç”¨è€…åç¨±èˆ‡é¡¯ç¤ºä»£è¡¨è§’è‰² -->
  <script>
    function sanitize(s){
      return String(s).replace(/[<>&"']/g, c => (
        {'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;','\'':'&#39;'}[c]
      ));
    }

    // å–å¾—ç›®å‰ä½¿ç”¨è€…ï¼ˆå¾ ?username= å–ï¼‰
    function getCurrentUsername(){
      const params = new URLSearchParams(location.search);
      const u = params.get('username');
      return u;
    }

    // API å¹«æ‰‹ï¼šæ ¹æ“šæ˜¯å¦ file:// åšæœ¬æ©Ÿ/åŒç¶²åŸŸ
    const API_BASE = location.protocol.startsWith("http") ? "" : "http://127.0.0.1:3000";
    const authToken = {
      get: () => localStorage.getItem("AUTH_TOKEN") || "",
      set: (t) => localStorage.setItem("AUTH_TOKEN", t || ""),
      clear: () => localStorage.removeItem("AUTH_TOKEN"),
    };

    async function apiFetch(url, options = {}) {
      const headers = new Headers(options.headers || {});
      const t = authToken.get();
      if (t) headers.set("Authorization", "Bearer " + t);
      const res = await fetch(url, { credentials: "include", ...options, headers });
      return res;
    }

    

    const API = {
      // ä¿®æ”¹å¯†ç¢¼ API
      auth: {
        login:  API_BASE + "/api/auth/login",
        me:     API_BASE + "/api/auth/me",
        changePassword: API_BASE + "/api/auth/change-password",
        logout: API_BASE + "/api/auth/logout",
      },
      projects: {
        list:   API_BASE + "/api/projects",
        create: API_BASE + "/api/projects",
        update: (id) => API_BASE + "/api/projects/" + id,
        remove: (id) => API_BASE + "/api/projects/" + id,
      },
      responsibleUserOptions: API_BASE + "/api/responsible-user/options",
      stage: {
        plan:   (projectDbId) => API_BASE + `/api/projects/${projectDbId}/stage-plan`,
        done:   (projectDbId, stageNo) => API_BASE + `/api/projects/${projectDbId}/stages/${stageNo}/complete`,
        list:   (projectDbId) => API_BASE + `/api/projects/${projectDbId}/stages`,
      },
    };

    // stage å°æ‡‰ class çš„ map
    const stageClassMap = { waiting: 'status-waiting', design: 'status-design', build: 'status-build' };
    const stageValueMap = { 0:'waiting', 1:'design', 2:'build' };

    // ä¿ç•™ç›®å‰ç™»å…¥è€…è³‡è¨Šï¼ˆä¾›å»ºç«‹å°ˆæ¡ˆç”¨ï¼‰
    window.__ME__ = null;  // å»ºç«‹è€…è³‡è¨Šç”±æ­¤å¸¶å…¥å¾Œç«¯

    /* ä»¥ DB id æš«å­˜ç•¶å‰åˆ—è¡¨è³‡æ–™ï¼Œä¾›ç·¨è¼¯å¡«å…¥ */
    const projectsById = new Map();
    function upsertProjectIntoMap(p){
      projectsById.set(String(p.id), p);   // ä»¥å­—ä¸²ç‚º key
    }

    // é–‹æ©Ÿï¼šæ’ˆä½¿ç”¨è€… + å°ˆæ¡ˆæ¸…å–®
    (async function boot(){
      try {
        const res = await apiFetch(API.auth.me); // å¸¶ token
        if (!res.ok) throw new Error("fetch /me failed");
        const json = await res.json();
        const me = json?.data || json; // åŒæ™‚æ”¯æ´ {ok,data} æˆ–ç›´æ¥ç‰©ä»¶
        window.__ME__ = me;
        document.getElementById('accountName').textContent = me.username || me.name || 'â€”';
        const roleCode  = (me.role_code || me.role || '').toString().trim();
        const roleLabel = me.role_label || (roleCode === 'admin' ? 'ç³»çµ±ç®¡ç†å“¡' : (roleCode ? 'ä¸€èˆ¬æœƒå“¡' : 'â€”'));
        document.getElementById('accountRole').textContent = roleLabel;
      } catch (err) {
        console.error("[boot] failed:", err);
        document.getElementById('accountName').textContent ||= 'â€”';
        document.getElementById('accountRole').textContent ||= 'â€”';
      }

      await loadAndRenderProjects();
    })();

    // å¾å¾Œç«¯è¼‰å…¥å°ˆæ¡ˆä¸¦æ¸²æŸ“
    async function loadAndRenderProjects(){
      const grid = document.getElementById('projectsGrid');
      grid.innerHTML = ""; // å…ˆæ¸…ç©º
      try{
        const res = await apiFetch(API.projects.list);
        const data = await res.json();
        const ok = (data?.ok !== undefined) ? data.ok : res.ok;
        if(!ok) throw new Error(data?.message || "load failed");
        const rows = data?.data || data || [];

        /* åŒæ­¥å¿«å– */
        projectsById.clear();

        for(const p of rows){
          projectsById.set(String(p.id), p);
          grid.appendChild(renderProjectRow(p));
        }
      }catch(e){
        console.error("load projects failed:", e);
        grid.innerHTML = `<div style="padding:12px;color:#b91c1c">è¼‰å…¥å¤±æ•—ï¼š${sanitize(e.message)}</div>`;
      }

      // è¼‰å…¥å®Œè³‡æ–™å°±å…ˆå¥—ç”¨ä¸€æ¬¡ç›®å‰é ç°½çš„é¡¯ç¤ºè¦å‰‡
      applyFilter();
    }

    // ç”¢ç”Ÿä¸€åˆ— DOMï¼ˆå« 8 å€‹ä»»å‹™æ ¼ï¼‰
    function renderProjectRow(p){
      // p ä¾†è‡ª v_projectï¼šåŒ…å« id, project_id, name, stage_code æˆ– stage_id æˆ– stage
      const currentStage = (p.stage_code || stageValueMap[p.stage_id] || 'waiting');

      const row = document.createElement('div');
      row.className = `project-row mode-default ${stageClassMap[currentStage] || ''}`;
      row.dataset.dbId = String(p.id);              // çœŸæ­£ DB idï¼ˆä¹‹å¾Œ PATCH ç”¨ï¼‰
      row.dataset.projectId = p.project_id; // é¡¯ç¤ºçš„ç·¨è™Ÿ

      // åˆ¤æ–·æ˜¯å¦å®Œæˆ
      const isDone = p.stage_id === 3;
      if (isDone) row.classList.add('is-done');
       //æŠŠ updated_at æ­£è¦åŒ–å¾Œå¡é€² datasetï¼ˆä¾›å·²å®Œæˆåˆ†é æ’åºï¼‰
      {
        const u = p.updated_at || p.updatedAt || p.updated_at_ts || null;
        if (u) {
          const iso = new Date(u).toISOString();
          if (!Number.isNaN(Date.parse(iso))) {
            row.dataset.updatedAt = iso;          
          }
        } else {
          row.dataset.updatedAt = '';               // æ²’æ™‚é–“è³‡æ–™ â†’ æ’å¾Œé¢
        }
      }

      // å¾å¾Œç«¯è¼‰å…¥ç‡ˆè™Ÿï¼Œä¸¦æŠŠ 8 æ ¼ä¸Šè‰²ï¼ˆnone / warn / danger / doneï¼‰
      async function loadStageLights(p, rowEl){
        try{
          // è‹¥æ²’æœ‰é–‹å§‹æ—¥/å·¥æœŸï¼Œå¤šåŠæ˜¯æ–°æ¡ˆ â†’ ç›´æ¥æ¸…ç©ºç‹€æ…‹ï¼Œä¸æ‹‹éŒ¯
          // ä½†æˆ‘å€‘ä»å‘¼å« APIï¼Œå› ç‚ºå¾Œç«¯æœƒç”¨ DB å€¼ï¼›è‹¥ DB ä¹Ÿæ²’æœ‰å°±å› 400
          const url = API.stage.plan(p.id);
          const res = await apiFetch(url);
          const json = await res.json().catch(()=>null);

          // å¤±æ•—å°±ä¸å‹•ï¼Œç¶­æŒé è¨­ç°åº•
          if(!res.ok || !json || json.ok === false){ return; }

          const stages = json.data?.stages || [];
          const cellByNo = {};
          rowEl.querySelectorAll('.task-cell').forEach(el=>{
            const n = Number(el.dataset.stageNo || 0);
            if(n>=1 && n<=8) cellByNo[n] = el;
            el.dataset.state = '';  // æ¸…ç©º
          });

          stages.forEach(s=>{
            const cell = cellByNo[s.no];
            if(!cell) return;
            if(s.status === 'green')  cell.dataset.state = 'done';     // ç¶ ç‡ˆ
            else if(s.status === 'red')   cell.dataset.state = 'danger'; // ç´…ç‡ˆ
            else if(s.status === 'orange')cell.dataset.state = 'warn';   // æ©˜ç‡ˆ
            else cell.dataset.state = ''; // ä¸€èˆ¬
          });
        }catch(e){
          console.warn('[stage-plan] load failed for project', p.id, e);
        }
      }

      // ç¶å®šé»æ“Šæ¯ä¸€æ ¼ï¼šé»ä¸€ä¸‹ â†’ é€å‡ºå®Œæˆï¼ˆè¦†è“‹é‚£ä¸€éšæ®µï¼‰â†’ è©²æ ¼è®Šç¶ 
      function bindStageCellClicks(rowEl, p){
        rowEl.querySelectorAll('.task-cell').forEach(cell=>{
          cell.addEventListener('click', async ()=>{
            const no = Number(cell.dataset.stageNo || 0);
            if(!no) return;

            // é€™è£¡å…ˆé¡¯ç¤ºã€Œä¸Šå‚³é ç•™ã€ï¼Œç¾åœ¨åªé€å‡ºå®Œæˆç´€éŒ„
            try{
              const res = await apiFetch(API.stage.done(p.id, no), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_url: null }) // å…ˆç•™ç©ºï¼Œä¹‹å¾Œä¸²çœŸå¯¦ä¸Šå‚³
              });
              const json = await res.json().catch(()=>null);
              if(!res.ok || !json || json.ok === false){
                alert('å®Œæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦'); return;
              }
              // åªæŠŠæœ¬æ ¼è®Šç¶ ï¼ˆdoneï¼‰ï¼Œä¸å‹•å…¶ä»–æ ¼
              cell.dataset.state = 'done';

              // ä½ è¦ã€Œé»äº†å°±é–‹ä¸Šå‚³ã€å¯ä»¥åœ¨é€™è£¡å‘¼å«å½ˆçª—æˆ–é¡¯ç¤ºå€å¡Šï¼ˆå…ˆç•™ç™½ï¼‰
              // Swal.fire({ icon: 'success', title: 'å·²æ¨™è¨˜å®Œæˆ', text: 'ä¹‹å¾Œå¯åœ¨æ­¤ä¸Šå‚³æª”æ¡ˆ' });
            }catch(e){
              console.error('[stage done] failed', e);
              alert('ç¶²è·¯ç•°å¸¸ï¼Œè«‹ç¨å¾Œé‡è©¦');
            }
          });
        });
      }


      //æŠŠ created_at æ­£è¦åŒ–å¾Œå¡åˆ° datasetï¼ˆä¾›ã€Œå…¨éƒ¨ã€åˆ†é æ’åºï¼‰
      {
        const c = p.created_at || p.createdAt || null;
        if (c) {
          const iso = new Date(c).toISOString();
          if (!Number.isNaN(Date.parse(iso))) {
            row.dataset.createdAt = iso;          
          }
        } else {
          row.dataset.createdAt = '';              // æ²’æ™‚é–“è³‡æ–™ â†’ æ’å¾Œé¢
        }
      }

      // éšæ®µä¸‹æ‹‰(æœªå®Œæˆ)
      const cellStage = document.createElement('div');
      cellStage.className = 'cell-stage';

      const sel = document.createElement('select');
      sel.className = 'stage-select';
      sel.innerHTML = `
        <option value="0">ç­‰å¾…</option>
        <option value="1">è¨­è¨ˆ</option>
        <option value="2">æ–½å·¥</option>
      `;
      sel.value = String(p.stage_id ?? 0);

      // å®Œæˆåˆ—å…ˆé–å®šä¸‹æ‹‰ï¼›åœ¨ã€Œå…¨éƒ¨/å·²å®Œæˆã€é ç°½æœƒè¢«æ›¿æ›æˆå¾½ç« 
      sel.disabled = isDone;

      /* ===== è¦–çª—å€‘ï¼ˆå…¨åŸŸåªæ›ä¸€æ¬¡ï¼Œé¿å…é‡è¤‡å®£å‘Šï¼‰ ===== */
      if (!window.openStageMetaDialogRequired) {
        // ç¼ºè³‡æ–™æ™‚ç”¨ï¼šå¿…å¡«è¼¸å…¥
        window.openStageMetaDialogRequired = async function({ title, start_date=null, estimated_days=null } = {}){
          const { isConfirmed, value } = await Swal.fire({
            title: title || 'è«‹å¡«å¯«éšæ®µè³‡è¨Š',
            html: `
              <div style="text-align:left">
                <label style="display:block;margin:6px 0 4px">é–‹å§‹æ—¥æœŸï¼ˆå¿…å¡«ï¼‰</label>
                <input id="swal-input-date" type="date" class="swal2-input" style="width:80%;box-sizing:border-box" value="${start_date ?? ''}">
                <label style="display:block;margin:10px 0 4px">å·¥æœŸå¤©æ•¸ï¼ˆå¿…å¡«ï¼‰</label>
                <input id="swal-input-days" type="number" min="1" step="1" placeholder="å¤©æ•¸" class="swal2-input" style="width:80%;box-sizing:border-box" value="${estimated_days ?? ''}">
              </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'ç¢ºèª',
            cancelButtonText: 'å–æ¶ˆ',
            preConfirm: () => {
              const d = document.getElementById('swal-input-date').value;
              const daysStr = document.getElementById('swal-input-days').value.trim();
              if (!d) { Swal.showValidationMessage('è«‹å¡«å¯«ã€Œé–‹å§‹æ—¥æœŸã€'); return false; }
              if (daysStr === '') { Swal.showValidationMessage('è«‹å¡«å¯«ã€Œå·¥æœŸå¤©æ•¸ã€'); return false; }
              const n = Number(daysStr);
              if (!Number.isFinite(n) || n <= 0) { Swal.showValidationMessage('ã€Œå·¥æœŸå¤©æ•¸ã€å¿…é ˆ > 0 çš„æ•´æ•¸'); return false; }
              return { start_date: d, estimated_days: n };
            }
          });
          return isConfirmed ? value : null;
        };
      }

      if (!window.confirmStageWithExisting) {
        // å·²æœ‰è³‡æ–™æ™‚ç”¨ï¼šé¡¯ç¤ºç¾æœ‰å€¼â†’ ç¢ºèª / ä¿®æ”¹ / å–æ¶ˆ
        window.confirmStageWithExisting = async function({ title, start_date, estimated_days }){
          const { isConfirmed, isDenied } = await Swal.fire({
            icon: 'question',
            title: title || 'ç¢ºèªéšæ®µè³‡è¨Š',
            html: `
              <div style="text-align:left">
                <div style="margin:6px 0"><strong>é–‹å§‹æ—¥æœŸï¼š</strong>${start_date}</div>
                <div style="margin:6px 0"><strong>å·¥æœŸå¤©æ•¸ï¼š</strong>${estimated_days} å¤©</div>
              </div>
            `,
            showDenyButton: true,
            showCancelButton: true,
            confirmButtonText: 'ç¢ºèªä½¿ç”¨é€™äº›å€¼',
            denyButtonText: 'æˆ‘è¦ä¿®æ”¹',
            cancelButtonText: 'å–æ¶ˆ',
          });
          return { useExisting: isConfirmed, editInstead: isDenied };
        };
      }

      /* ===== è®Šæ›´äº‹ä»¶ï¼šéç­‰å¾… â†’ å…ˆçœ‹æœ‰æ²’æœ‰ç¾æœ‰å€¼ï¼›ç­‰å¾… â†’ åªæ”¹éšæ®µï¼Œä¸å‹•æ—¥æœŸ/å¤©æ•¸ ===== */
      sel.addEventListener('change', async (e) => {
        const prevVal = Number(p.stage_id ?? 0);
        const newVal  = Number(e.target.value);
        const newCode = stageValueMap[newVal] || 'waiting';

        if (newVal !== 0) {
          // éç­‰å¾…ï¼šè‹¥å·²æœ‰å€¼ â†’ å…ˆé¡¯ç¤ºç¢ºèªï¼›æ²’æœ‰å€¼ â†’ ç›´æ¥é–‹å¿…å¡«è¼¸å…¥
          if (p.start_date && p.estimated_days != null) {
            const { useExisting, editInstead } = await window.confirmStageWithExisting({
              title: newVal === 1 ? 'åˆ‡æ›åˆ°ã€Œè¨­è¨ˆã€' :
                    newVal === 2 ? 'åˆ‡æ›åˆ°ã€Œæ–½å·¥ã€' : 'åˆ‡æ›éšæ®µ',
              start_date: p.start_date,
              estimated_days: p.estimated_days
            });

            if (!useExisting && !editInstead) {
              // ä½¿ç”¨è€…å–æ¶ˆ â†’ é‚„åŸ
              sel.value = String(prevVal);
              return;
            }

            let start_date = p.start_date;
            let estimated_days = p.estimated_days;

            if (editInstead) {
              // æƒ³ä¿®æ”¹ â†’ æ‰“é–‹å¿…å¡«è¼¸å…¥è¦–çª—
              const got = await window.openStageMetaDialogRequired({
                title: 'ä¿®æ”¹éšæ®µè³‡è¨Š',
                start_date,
                estimated_days
              });
              if (!got) {
                sel.value = String(prevVal);
                return;
              }
              start_date = got.start_date;
              estimated_days = got.estimated_days;
            }

            // æ›´æ–°æ¨£å¼
            row.classList.remove('status-waiting','status-design','status-build');
            row.classList.add(stageClassMap[newCode] || '');

            // æ¨™é«’ï¼ˆç”¨ç¾æœ‰æˆ–ä¿®æ”¹å¾Œçš„å€¼ï¼‰
            markDirty(p.id, {
              stage_id: newVal,
              start_date,
              estimated_days
            });

            // å‰ç«¯æ¨¡å‹åŒæ­¥
            p.stage_id       = newVal;
            p.stage          = newCode;
            p.stage_code     = newCode;
            p.start_date     = start_date;
            p.estimated_days = estimated_days;

          } else {
            // æ²’æœ‰å®Œæ•´å€¼ â†’ ç›´æ¥è¦æ±‚å¿…å¡«
            const got = await window.openStageMetaDialogRequired({
              title: newVal === 1 ? 'è¨­å®šã€Œè¨­è¨ˆã€éšæ®µ' :
                    newVal === 2 ? 'è¨­å®šã€Œæ–½å·¥ã€éšæ®µ' : 'è¨­å®šéšæ®µè³‡è¨Š',
              start_date: p.start_date ?? null,
              estimated_days: p.estimated_days ?? null
            });
            if (!got) {
              sel.value = String(prevVal);
              return;
            }

            row.classList.remove('status-waiting','status-design','status-build');
            row.classList.add(stageClassMap[newCode] || '');

            markDirty(p.id, {
              stage_id: newVal,
              start_date: got.start_date,
              estimated_days: got.estimated_days
            });

            p.stage_id       = newVal;
            p.stage          = newCode;
            p.stage_code     = newCode;
            p.start_date     = got.start_date;
            p.estimated_days = got.estimated_days;
          }

        } else {
          // ç­‰å¾…ï¼šåªæ›´æ–°éšæ®µï¼›ä¿ç•™æ—¥æœŸèˆ‡å¤©æ•¸åŸå€¼ï¼ˆä¸æ¸…ç©ºã€ä¸è¦æ±‚è¼¸å…¥ï¼‰
          row.classList.remove('status-waiting','status-design','status-build');
          row.classList.add(stageClassMap['waiting'] || '');

          markDirty(p.id, { stage_id: 0 }); // åƒ…æ¨™è¨˜éšæ®µæ”¹è®Š

          p.stage_id   = 0;
          p.stage      = 'waiting';
          p.stage_code = 'waiting';
          // p.start_date / p.estimated_days ç¶­æŒåŸå€¼
        }
      });

      cellStage.appendChild(sel);
      row.appendChild(cellStage);




      // ç·¨è™Ÿ & æ¡ˆå
      const cellId = document.createElement('div');
      cellId.className = 'cell-id';
      cellId.textContent = p.project_id;
      row.appendChild(cellId);

      const cellName = document.createElement('div');
      cellName.className = 'cell-name';
      cellName.textContent = p.name;
      row.appendChild(cellName);

      // å›ºå®šçš„ 8 å€‹å·¥ä½œæ ¼ï¼ˆé è¨­ç‹€æ…‹ç‚ºä¸€èˆ¬ï¼›è‹¥å¾Œç«¯æœ‰ç‹€æ…‹è³‡æ–™ï¼Œå¯å¥—ä¸Š data-stateï¼‰
      const taskLabels = ["ä¸ˆé‡","æ¡ˆä¾‹åˆ†æ","å¹³é¢æ”¾æ¨£","å¹³é¢åœ–","å¹³é¢ç³»çµ±åœ–","ç«‹é¢æ¡†é«”åœ–","ç«‹é¢åœ–","æ–½å·¥åœ–"];
      taskLabels.forEach((label, idx)=>{
        const no = idx + 1; // 1..8
        const c = document.createElement('div');
        c.className = 'task-cell';
        c.dataset.stageNo = String(no);         // <â”€â”€ çµ¦å¾ŒçºŒæ›ç‹€æ…‹/é»æ“Šç”¨
        c.innerHTML = `<span>${label}</span>`;
        row.appendChild(c);
      });
      bindStageCellClicks(row, p);       // ç¶å®šé»æ“Š â†’ ç¶ ç‡ˆ + POST å®Œæˆ
      loadStageLights(p, row);           // å¾å¾Œç«¯æ’ˆè¨ˆç•« â†’ æ©˜/ç´…/ç¶ 

      // ===== å‹•ä½œæŒ‰éˆ•ï¼ˆç·¨è¼¯ / åˆªé™¤ / å·²å®Œæˆï¼‰ =====

      // ç·¨è¼¯ï¼ˆâœï¸ï¼‰
      const btnEdit = document.createElement('button');
      btnEdit.className = 'action-btn js-action';
      btnEdit.dataset.action = 'edit';
      btnEdit.dataset.dbId   = String(p.id);
      btnEdit.title = 'ç·¨è¼¯';
      btnEdit.setAttribute('aria-label', 'ç·¨è¼¯');
      btnEdit.textContent = 'âœï¸';
      row.appendChild(btnEdit);

      // åˆªé™¤ï¼ˆğŸ—‘ï¸ï¼‰
      const btnDelete = document.createElement('button');
      btnDelete.className = 'action-btn js-action';
      btnDelete.dataset.action = 'delete';
      btnDelete.dataset.dbId = String(p.id);
      btnDelete.title = 'åˆªé™¤';
      btnDelete.setAttribute('aria-label', 'åˆªé™¤');
      btnDelete.textContent = 'ğŸ—‘ï¸';
      row.appendChild(btnDelete);

      // å·²å®Œæˆï¼ˆâœ…ï¼‰
      const btnDone = document.createElement('button');
      btnDone.className = 'action-btn js-action action-done';
      btnDone.dataset.action = 'done';
      btnDone.dataset.dbId   = String(p.id);
      btnDone.title = 'æ¨™è¨˜ç‚ºå·²å®Œæˆ';
      btnDone.setAttribute('aria-label', 'æ¨™è¨˜ç‚ºå·²å®Œæˆ');
      btnDone.textContent = 'âœ…';
      row.appendChild(btnDone);

      return row;
    }

    // æ¨™è¨˜ dirtyï¼ˆåˆä½µè®Šæ›´ï¼‰
    const dirty = new Map(); // key: project.id (æ•¸å­—)ï¼Œval: å±€éƒ¨æ›´æ–°ç‰©ä»¶
    function markDirty(id, patch){
      const prev = dirty.get(id) || {};
      dirty.set(id, { ...prev, ...patch });

      // é¡¯ç¤ºã€Œæœªå„²å­˜æç¤ºã€
      const notice = document.getElementById('unsavedNotice');
      if (notice) notice.style.display = '';
    }
  </script>

  <script>
    // åˆ†é åˆ‡æ› æ§åˆ¶å™¨
    const navButtons = document.querySelectorAll('.nav button');
    const views = {
      projects: document.getElementById('view-projects'),
      password: document.getElementById('view-password'),
    };
    const titleMap = {
      projects: 'æ‰€æœ‰å°ˆæ¡ˆé€²åº¦',
      password: 'ä¿®æ”¹å¯†ç¢¼'
    };

    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        navButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const key = btn.dataset.view;
        Object.values(views).forEach(v => v.style.display = 'none');
        views[key].style.display = '';
        document.getElementById('pageTitle').textContent = titleMap[key];
      });
    });
  </script>

  <script>
    // å…±ç”¨é€å‡ºé‚è¼¯ï¼ˆæ–°å¢ / ç·¨è¼¯éƒ½æœƒå‘¼å«é€™è£¡ï¼‰
    async function saveProject(body){
      const isEdit = !!body.id;   // æœ‰ id = ç·¨è¼¯ï¼Œæ²’æœ‰ id = æ–°å¢
      const url = isEdit ? API.projects.update(body.id) : API.projects.create;

      const res = await apiFetch(url, {
        method: isEdit ? 'PATCH' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      const data = await res.json();
      if (!res.ok || !data.ok) throw new Error(data.message || "å¤±æ•—");

      alert(isEdit ? "å·²æ›´æ–°å°ˆæ¡ˆ" : "å·²æ–°å¢å°ˆæ¡ˆ");
      await loadAndRenderProjects();
    }
  </script>

  <script>
    // âœ… å„²å­˜æ‰¹æ¬¡æ›´æ–°ï¼ˆåŠ å…¥ SweetAlert loading + è‡ªå‹•åˆ·æ–°ç‡ˆè™Ÿï¼‰
    document.getElementById('saveBtn').addEventListener('click', async () => {
      if (dirty.size === 0) {
        Swal.fire({ icon: 'info', title: 'æ²’æœ‰è®Šæ›´', timer: 800, showConfirmButton: false });
        return;
      }

      Swal.fire({
        title: 'æ›´æ–°ä¸­...',
        allowOutsideClick: false,
        didOpen: () => Swal.showLoading()
      });

      try {
        // å¹³è¡Œé€å‡ºæ‰€æœ‰è®Šæ›´
        const jobs = Array.from(dirty.entries()).map(([id, patch]) =>
          apiFetch(API.projects.update(id), {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(patch)
          }).then(async (res) => {
            if (!res.ok) throw new Error(await res.text());
            return id;
          })
        );

        const results = await Promise.allSettled(jobs);
        const successIds = results.filter(r => r.status === 'fulfilled').map(r => r.value);

        // ç§»é™¤æˆåŠŸçš„ dirty
        for (const id of successIds) dirty.delete(id);

        Swal.close();

        if (successIds.length > 0) {
          Swal.fire({ icon: 'success', title: `å·²æ›´æ–° ${successIds.length} ç­†`, timer: 1000, showConfirmButton: false });
        }

        // æ›´æ–°å¾Œé‡æ–°è¼‰å…¥æ‰€æœ‰å°ˆæ¡ˆï¼Œåˆ·æ–°ç‡ˆè™Ÿ
        await loadAndRenderProjects();

        // éš±è—æœªå„²å­˜æç¤º
        document.getElementById('unsavedNotice').style.display = 'none';

      } catch (e) {
        Swal.close();
        console.error(e);
        Swal.fire('éŒ¯èª¤', 'æ›´æ–°æ™‚ç™¼ç”ŸéŒ¯èª¤', 'error');
      }
    });
  </script>






  <!-- <script>
  /**
   * å¿…å¡«ç‰ˆæœ¬ï¼šstart_date èˆ‡ estimated_days éƒ½å¿…å¡«
   * - start_date: YYYY-MM-DD
   * - estimated_days: æ­£æ•´æ•¸
   */
  async function openStageMetaDialogRequired({ title, start_date = null, estimated_days = null } = {}) {
    const { isConfirmed, value } = await Swal.fire({
      title: title || 'è«‹å¡«å¯«éšæ®µè³‡è¨Š',
      html: `
        <div style="text-align:left">
          <label style="display:block;margin:6px 0 4px">é–‹å§‹æ—¥æœŸï¼ˆå¿…å¡«ï¼‰</label>
          <input id="swal-input-date" type="date" class="swal2-input" style="width:100%;box-sizing:border-box" value="${start_date ?? ''}">
          <label style="display:block;margin:10px 0 4px">å·¥æœŸå¤©æ•¸ï¼ˆå¿…å¡«ï¼‰</label>
          <input id="swal-input-days" type="number" min="1" step="1" placeholder="å¤©æ•¸" class="swal2-input" style="width:100%;box-sizing:border-box" value="${estimated_days ?? ''}">
        </div>
      `,
      focusConfirm: false,
      showCancelButton: true,
      confirmButtonText: 'ç¢ºèª',
      cancelButtonText: 'å–æ¶ˆ',
      allowOutsideClick: () => !Swal.isLoading(),
      preConfirm: () => {
        const d = document.getElementById('swal-input-date').value;
        const daysStr = document.getElementById('swal-input-days').value.trim();

        if (!d) {
          Swal.showValidationMessage('è«‹å¡«å¯«ã€Œé–‹å§‹æ—¥æœŸã€');
          return false;
        }
        if (daysStr === '') {
          Swal.showValidationMessage('è«‹å¡«å¯«ã€Œå·¥æœŸå¤©æ•¸ã€');
          return false;
        }
        const n = Number(daysStr);
        if (!Number.isFinite(n) || n <= 0) {
          Swal.showValidationMessage('ã€Œå·¥æœŸå¤©æ•¸ã€å¿…é ˆæ˜¯å¤§æ–¼ 0 çš„æ•´æ•¸');
          return false;
        }
        return { start_date: d, estimated_days: n };
      }
    });

    return isConfirmed ? value : null;
  }
  </script> -->







  <script>
  // ä¿®æ”¹å¯†ç¢¼
  document.getElementById('savePwd').addEventListener('click', async () => {
    const oldPwd = document.getElementById('oldPwd').value.trim();
    const newPwd = document.getElementById('newPwd').value.trim();
    const newPwd2 = document.getElementById('newPwd2').value.trim();
    const msg = document.getElementById('pwdMsg');

    // æ¸…è¨Šæ¯
    msg.style.color = '#6b7280';
    msg.textContent = '';

    // åŸºæœ¬é©—è­‰
    if (!oldPwd || !newPwd || !newPwd2) {
      msg.style.color = '#b91c1c';
      msg.textContent = 'è«‹å®Œæ•´å¡«å¯«æ‰€æœ‰æ¬„ä½';
      return;
    }
    if (newPwd.length < 6) {
      msg.style.color = '#b91c1c';
      msg.textContent = 'æ–°å¯†ç¢¼é•·åº¦éœ€è‡³å°‘ 6 ç¢¼';
      return;
    }
    // è‹¥è¦å¼·åˆ¶ã€Œè‡³å°‘ 6 ç¢¼ä¸”éœ€åŒ…å«è‹±æ–‡å­—æ¯èˆ‡æ•¸å­—ã€â†’ æ‰“é–‹ä¸‹ä¸€è¡Œè¨»è§£ï¼š
    // if (!/(?=.*[A-Za-z])(?=.*\d).{6,}/.test(newPwd)) { msg.style.color='#b91c1c'; msg.textContent='å¯†ç¢¼éœ€è‡³å°‘6ç¢¼ï¼Œä¸”åŒ…å«è‹±æ–‡å­—æ¯èˆ‡æ•¸å­—'; return; }

    if (newPwd !== newPwd2) {
      msg.style.color = '#b91c1c';
      msg.textContent = 'å…©æ¬¡è¼¸å…¥çš„æ–°å¯†ç¢¼ä¸ä¸€è‡´';
      return;
    }

    // é–æŒ‰éˆ•é¿å…é‡è¤‡é€å‡º
    const btn = document.getElementById('savePwd');
    const origText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'é€å‡ºä¸­â€¦';

    try {
      const res = await apiFetch(API.auth.changePassword, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          current_password: oldPwd,
          new_password: newPwd,
          confirm_password: newPwd2
        })
      });

      if (res.status === 401) {
        msg.style.color = '#b45309';
        msg.textContent = 'å°šæœªç™»å…¥æˆ–ç™»å…¥å·²éæœŸï¼Œè«‹é‡æ–°ç™»å…¥';
        return;
      }

      // æˆåŠŸï¼šå¾Œç«¯å¯èƒ½å› 200 æˆ– 204
      if (res.ok) {
        const data = await res.json().catch(()=>({}));
        if (data.token) authToken.set(data.token); // è‹¥æœ‰å›å‚³æ–° token å°±æ›´æ–°

        msg.style.color = '#065f46';
        msg.textContent = 'å¯†ç¢¼å·²æ›´æ–°ï¼Œå…¶ä»–è£ç½®å·²ç™»å‡º';
        // æ¸…ç©ºæ¬„ä½
        document.getElementById('oldPwd').value = '';
        document.getElementById('newPwd').value = '';
        document.getElementById('newPwd2').value = '';
        return;
      }

      // å…¶å®ƒéŒ¯èª¤è®€å–è¨Šæ¯
      let data = {};
      try { data = await res.json(); } catch (_) {}
      msg.style.color = '#b91c1c';
      msg.textContent = data.msg || 'ä¿®æ”¹å¯†ç¢¼å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
    } catch (err) {
      console.error('[change-password] failed', err);
      msg.style.color = '#b91c1c';
      msg.textContent = 'é€£ç·šç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦';
    } finally {
      btn.disabled = false;
      btn.textContent = origText || 'å„²å­˜';
    }
  });
  </script>


  <script>
    // ç™»å‡º
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        await apiFetch(API.auth.logout, { method: 'POST' });            // é€šçŸ¥å¾Œç«¯æ¸… cookie
      } catch {}
      authToken.clear();                                                // æ¸…æ‰ Bearer
      sessionStorage.clear();
      window.location.href = "/login.html";
    });
  </script>

  <!-- Modal æ§åˆ¶ + åˆ—è¡¨äº‹ä»¶ + é ç°½é‚è¼¯ -->
  <script>
    const addBtn = document.getElementById('addProjectBtn');
    const modal = document.getElementById('createModal');
    const closeBtn = document.getElementById('modalCloseBtn');

    // æ–°å¢ / ç·¨è¼¯å…±ç”¨ï¼šè¼‰å…¥è² è²¬äººï¼›selectedId å¯ç‚º null/undefined/''ï¼ˆä»£è¡¨æœªæŒ‡æ´¾ï¼‰
    async function loadResponsibleOptionsInto(selectEl, selectedId = '') {
      try {
        // å…ˆæ¸…åˆ°åªå‰©æœªæŒ‡æ´¾ï¼Œé¿å…èˆŠé¸é …æ®˜ç•™
        selectEl.innerHTML = '<option value="">ï¼ˆæœªæŒ‡æ´¾ï¼‰</option>';

        const res = await apiFetch(API.responsibleUserOptions);
        const json = await res.json();
        const users = Array.isArray(json?.data) ? json.data : (Array.isArray(json) ? json : []);

        for (const u of users) {
          const opt = document.createElement('option');
          opt.value = String(u.id);
          opt.textContent = u.name || u.username || String(u.id);
          selectEl.appendChild(opt);
        }

        // â€”â€” æ ¸å¿ƒï¼šåš´è¬¹é¸å€¼ï¼ˆæ‰¾ä¸åˆ°å°±é¸ç¬¬ 0 å€‹ï¼‰
        const target = (selectedId === null || selectedId === undefined) ? '' : String(selectedId).trim();
        const match  = Array.from(selectEl.options).find(o => String(o.value).trim() === target);

        if (match) {
          selectEl.value = match.value;     // ç¢ºä¿ç”¨ options ä¸­çš„ value
        } else {
          selectEl.selectedIndex = 0;       // å¼·åˆ¶å›åˆ°ã€Œï¼ˆæœªæŒ‡æ´¾ï¼‰ã€
        }

        // é admin ä¸€å¾‹é–å®š
        const role = (window.__ME__?.role_code || window.__ME__?.role || '').toString().trim();
        selectEl.disabled = (role !== 'admin' && role !== 'ç³»çµ±ç®¡ç†å“¡');

      } catch (e) {
        console.warn('load responsible users failed', e);
        // ç™¼ç”ŸéŒ¯èª¤ä¹Ÿä¿è­‰å›åˆ°æœªæŒ‡æ´¾
        selectEl.innerHTML = '<option value="">ï¼ˆæœªæŒ‡æ´¾ï¼‰</option>';
        selectEl.selectedIndex = 0;

        // å¤±æ•—æ™‚åŒæ¨£é–å®šï¼Œé¿å…é€å‡ºå¥‡æ€ªå€¼
        selectEl.disabled = true;
      }
    }


    // æ‰“é–‹ã€Œæ–°å¢ã€ï¼šcreate æ¨¡å¼
    addBtn.addEventListener('click', async () => {
      modal.dataset.mode = 'create';          /* ğŸ†• æ–°å¢ */
      modal.dataset.editId = '';              /* ğŸ†• æ–°å¢ */
      document.querySelector('#createModal .modal-title').textContent = 'æ–°å¢å°ˆæ¡ˆ';
      document.getElementById('f_submit').textContent = 'é€å‡º';

      modal.style.display = 'flex';
      await loadResponsibleOptionsInto(document.getElementById('f_responsible_user'), '');

      // æ¸…ç©ºæ¬„ä½
      ['f_project_id','f_name','f_start_date','f_estimated_days'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('f_stage').value = '0';
      document.getElementById('f_responsible_user').value = '';
      updateDuePreview();

      // æ–°å¢æ™‚å…è¨±ç·¨è¼¯ç·¨è™Ÿ
      document.getElementById('f_project_id').disabled = false;
    });

    // é—œé–‰ Modal
    function closeModal(){
      modal.style.display = 'none';
      /* å¾©åŸç‹€æ…‹ */
      modal.dataset.mode = 'create';
      modal.dataset.editId = '';
      document.getElementById('f_project_id').disabled = false;
    }
    closeBtn.addEventListener('click', closeModal);
    document.getElementById('f_cancel').addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

    // due é è¦½
    function updateDuePreview() {
      const s = document.getElementById('f_start_date').value; // 'YYYY-MM-DD'
      const d = parseInt(document.getElementById('f_estimated_days').value, 10);
      const el = document.getElementById('f_due_preview');

      if (s && Number.isInteger(d) && d > 0) {
        // è§£æ 'YYYY-MM-DD'ï¼Œåªåšã€Œå¤©ã€ç´šé‹ç®—ï¼Œé¿å…æ™‚å€
        const [Y, M, D] = s.split('-').map(n => parseInt(n, 10));
        const base = new Date(Y, M - 1, D);              // ç”¨æœ¬åœ° Dateï¼Œä½†ä¸è¼¸å‡º ISO
        base.setHours(12, 0, 0, 0);                      // æ”¾ä¸­åˆï¼Œé¿å…å¤ä»¤/è·¨æ—¥é‚Šç•Œ
        // èˆ‡å¾Œç«¯è¦å‰‡ä¸€è‡´ï¼šplanned_end = start + (d - 1)
        base.setDate(base.getDate() + (d - 1));

        const y = base.getFullYear();
        const m = String(base.getMonth() + 1).padStart(2, '0');
        const day = String(base.getDate()).padStart(2, '0');
        el.textContent = `é è¨ˆå®Œå·¥æ—¥ï¼š${y}-${m}-${day}`;
      } else {
        el.textContent = 'é è¨ˆå®Œå·¥æ—¥ï¼šâ€”';
      }
    }
    document.getElementById('f_start_date').addEventListener('change', updateDuePreview);
    document.getElementById('f_estimated_days').addEventListener('input', updateDuePreview);

    /* æ‰“é–‹ã€Œç·¨è¼¯ã€çš„å‡½å¼ */
    async function openEditModal(p){
      const titleEl   = document.querySelector('#createModal .modal-title');
      const submitBtn = document.getElementById('f_submit');

      modal.dataset.mode = 'edit';
      modal.dataset.editId = String(p.id);

      titleEl.textContent = 'ç·¨è¼¯å°ˆæ¡ˆ';
      submitBtn.textContent = 'æ›´æ–°';

      modal.style.display = 'flex';

      const selRU = document.getElementById('f_responsible_user');
      await loadResponsibleOptionsInto(selRU, (p.responsible_user_id == null || p.responsible_user_id === '') ? '' : String(p.responsible_user_id));

      document.getElementById('f_project_id').value = p.project_id ?? '';
      document.getElementById('f_name').value       = p.name ?? '';
      document.getElementById('f_stage').value      = String(p.stage_id ?? 0);
      document.getElementById('f_start_date').value = p.start_date ?? '';
      document.getElementById('f_estimated_days').value = (p.estimated_days ?? '') === null ? '' : (p.estimated_days ?? '');

      updateDuePreview();

      // ç·¨è¼¯æ™‚é–å®š project_idï¼ˆæš«æ™‚é–å®šï¼Œå¦‚éœ€å¯æ”¹ç‚ºå¯ç·¨è¼¯ï¼‰
      document.getElementById('f_project_id').disabled = true;
    }

    // ===== Tabs / ç¯©é¸ / ç‰ˆå‹åˆ‡æ› =====
    let currentFilter = 'ongoing'; // é€²è¡Œä¸­(default)

    function renderHeaderFor(filter){
      const head = document.getElementById('gridHeader');
      if(!head) return;

      head.classList.remove('mode-done');
      head.classList.add('mode-default');

      head.innerHTML = `
        <div>éšæ®µ</div>
        <div>ç·¨è™Ÿ</div>
        <div>æ¡ˆå</div>
        <div class="action-head"></div>
        <div class="action-head"></div>
        <div class="action-head"></div>
      `;
    }

    function switchRowLayoutFor(filter){
      const rows = document.querySelectorAll('#projectsGrid .project-row');
      rows.forEach(r => {
        r.classList.add('mode-default');
        r.classList.remove('mode-done');
      });
    }

    // æŠŠå·²å®Œæˆåˆ—çš„ã€Œéšæ®µã€æ¬„æ›æˆå¾½ç« ï¼›é›¢é–‹æ™‚é‚„åŸ
    function refreshStageCellsForCurrentTab(){
      const rows = document.querySelectorAll('#projectsGrid .project-row');
      rows.forEach(row => {
        const stageCell = row.querySelector('.cell-stage');
        if (!stageCell) return;

        const isDoneRow = row.classList.contains('is-done');

        // âœ… åœ¨ã€Œå…¨éƒ¨ã€æˆ–ã€Œå·²å®Œæˆã€é ç°½ï¼ŒæŠŠå®Œæˆåˆ—é¡¯ç¤ºç‚ºå¾½ç« 
        const shouldShowBadge = isDoneRow && (currentFilter === 'all' || currentFilter === 'done');

        if (shouldShowBadge) {
          if (!stageCell.dataset.origHtml) {
            stageCell.dataset.origHtml = stageCell.innerHTML; // æš«å­˜åŸå§‹ select
          }
          stageCell.innerHTML = '<div class="badge-done">å·²å®Œæˆ</div>';
        } else {
          // é€²è¡Œä¸­åˆ†é æˆ–éå®Œæˆåˆ— â†’ é‚„åŸ select
          if (stageCell.dataset.origHtml) {
            stageCell.innerHTML = stageCell.dataset.origHtml;
            delete stageCell.dataset.origHtml;
          }
        }

        // åœ¨é€²è¡Œä¸­åˆ†é æ™‚ï¼Œå®Œæˆåˆ—çš„ select ä»é–å®šé¿å…èª¤æ”¹
        const sel = stageCell.querySelector('select');
        if (sel) sel.disabled = isDoneRow;
      });
    }



    function applyFilter(){
      const rows = document.querySelectorAll('#projectsGrid .project-row');

      rows.forEach(row => {
        const done = row.classList.contains('is-done');
        
        if (currentFilter === 'done') {
          row.style.display = done ? '' : 'none';
        } else if (currentFilter === 'ongoing') {
          row.style.display = done ? 'none' : '';
        } else {
          row.style.display = '';
        }


        // âœ… é¡¯ç¤ºè¦å‰‡ï¼šåœ¨ã€Œå·²å®Œæˆã€èˆ‡ã€Œå…¨éƒ¨ã€é ç°½ï¼Œå·²å®Œæˆçš„æ¡ˆå­éƒ½éš±è— âœ…
        const btnDone = row.querySelector('.action-done');
        if (btnDone) {
          btnDone.style.display = done ? 'none' : '';
        }
      });

      // Legend åªåœ¨é€²è¡Œä¸­é¡¯ç¤º
      const legend = document.getElementById('legendBar');
      if (legend) legend.style.display = (currentFilter === 'ongoing') ? '' : 'none';

      // è¡¨é ­å…§å®¹ + ç‰ˆå‹åˆ‡æ› + éšæ®µå¾½ç« /ä¸‹æ‹‰æ›¿æ›
      renderHeaderFor(currentFilter);
      switchRowLayoutFor(currentFilter);
      refreshStageCellsForCurrentTab();

      // åªåœ¨ã€Œå·²å®Œæˆã€åˆ†é ï¼Œä¾ updatedAt ç”±æ–°åˆ°èˆŠæ’åº
      if (currentFilter === 'done') {
        const grid = document.getElementById('projectsGrid');
        const rows = Array.from(grid.querySelectorAll('.project-row.is-done'));
        rows.sort((a, b) => {
          const ua = a.dataset.updatedAt || '';
          const ub = b.dataset.updatedAt || '';
          return ub.localeCompare(ua); // æ–°åœ¨å‰
        });
        rows.forEach(r => grid.appendChild(r)); // append æœƒç§»å‹•ç¯€é»
      }

      //åœ¨ã€Œå…¨éƒ¨ã€åˆ†é ä¾ created_at ç”±æ–°åˆ°èˆŠæ’åº
      if (currentFilter === 'all') {
        const grid = document.getElementById('projectsGrid');
        const rows = Array.from(grid.querySelectorAll('.project-row'));
        rows.sort((a, b) => {
          const ca = a.dataset.createdAt || '';   // æœŸå¾… ISO å­—ä¸²
          const cb = b.dataset.createdAt || '';
          return cb.localeCompare(ca);            // æ–°åœ¨å‰
        });
        rows.forEach(r => grid.appendChild(r));   // ä¾æ–°é †åºé‡æ›
      }
    }


    // Tabs é»æ“Š
    document.addEventListener('click', (e) => {
      const tab = e.target.closest('.tabs-row .tab');
      if(!tab) return;
      document.querySelectorAll('.tabs-row .tab').forEach(t => t.setAttribute('aria-selected','false'));
      tab.setAttribute('aria-selected','true');
      currentFilter = tab.dataset.filter || 'ongoing';
      applyFilter();
    });

    /* åˆ—è¡¨ä¸Šçš„ âœï¸ ğŸ—‘ï¸ âœ… */
    document.getElementById('projectsGrid').addEventListener('click', async (e) => {
      const btn = e.target.closest('.js-action');
      if(!btn) return;

      const action = btn.dataset.action;
      const idStr  = btn.dataset.dbId;     // dataset ä¸€å¾‹å­—ä¸²
      const p      = projectsById.get(idStr);

      if(action === 'edit'){
        if(!p){ alert('æ‰¾ä¸åˆ°è³‡æ–™'); return; }
        openEditModal(p);
        return;
      }

      if(action === 'delete'){
        if(!p){ alert('æ‰¾ä¸åˆ°è³‡æ–™'); return; }
        const ok = confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${p.project_id}ï½œ${p.name}ã€å—ï¼Ÿ`);
        if(!ok) return;

        try{
          const res = await apiFetch(API.projects.remove(idStr), {
            method: 'DELETE',
          });
          if(!res.ok){
            const t = await res.text();
            throw new Error(t || 'åˆªé™¤å¤±æ•—');
          }
          // åˆªé™¤æˆåŠŸï¼Œå¾ç•«é¢ç§»é™¤é€™ä¸€åˆ—
          btn.closest('.project-row')?.remove();
          projectsById.delete(idStr);
        }catch(err){
          console.error('[DELETE] failed', err);
          alert('åˆªé™¤å¤±æ•—ï¼š' + (err?.message || err));
        }
        return;
      }

      if(action === 'done'){
        if(!p){ alert('æ‰¾ä¸åˆ°è³‡æ–™'); return; }
        const ok = confirm(`è¦æŠŠã€Œ${p.project_id}ï½œ${p.name}ã€æ¨™è¨˜ç‚ºå·²å®Œæˆå—ï¼Ÿ`);
        if(!ok) return;

        try{
          // ç«‹å³æ–¼å‰ç«¯æ¨™è¨˜å®Œæˆ
          const rowEl = btn.closest('.project-row');
          rowEl?.classList.add('is-done');

          // å¯«å…¥å·²å®Œæˆçš„ç•¶ä¸‹æ™‚é–“ datasetï¼Œåˆ‡åˆ°ã€Œå·²å®Œæˆã€ç«‹åˆ»æœƒæ’æœ€ä¸Š
          rowEl.dataset.updatedAt = new Date().toISOString();

          //ï¼ˆå¯é¸ï¼‰å¾Œç«¯åŒæ­¥ï¼Œè‹¥å°šæœªæ”¯æ´å¯è¨»è§£
          apiFetch(API.projects.update(idStr), {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ stage_id:3 })
          }).catch(()=>{});

          applyFilter();
          alert('å·²æ¨™è¨˜ç‚ºå·²å®Œæˆ');
        }catch(err){
          console.error('[DONE] failed', err);
          alert('æ“ä½œå¤±æ•—ï¼š' + (err?.message || err));
        }
        return;
      }
    });

    // é€å‡ºï¼ˆå‘¼å«å…±ç”¨ saveProjectï¼‰
    document.getElementById('f_submit').addEventListener('click', async () => {
      const mode  = modal.dataset.mode || 'create'; /* æ–°å¢ */
      const editId = modal.dataset.editId || null;  /* ç·¨è¼¯ */

      const body = {
        project_id: document.getElementById('f_project_id').value.trim(),  // text
        name:       document.getElementById('f_name').value.trim(),        // text
        stage_id:   Number(document.getElementById('f_stage').value),      // æ•¸å­—
        start_date: document.getElementById('f_start_date').value || null,
        estimated_days: (()=>{ const v=document.getElementById('f_estimated_days').value; return v===''?null:Number(v) })(),
        responsible_user_id: (()=>{ const v=document.getElementById('f_responsible_user').value; return v===''?null : String(v) })(),
        // å¾ __ME__ å¸¶å…¥å»ºç«‹è€…ï¼ˆèˆ‡å¾Œç«¯æ¬„ä½å°é½Šï¼‰
        creator_user_id: window.__ME__?.id ?? null,
        creator_user_name: window.__ME__?.name ?? window.__ME__?.username ?? null
      };

      if(mode === 'edit' && editId){
        body.id = Number(editId); /* id(æ¯ä¸€å°ˆæ¡ˆåœ¨è³‡æ–™åº«çš„id) -> PATCH æ˜ç¢ºè½‰æˆæ•¸å­— */
      }


      if (!body.project_id || !body.name) {
        alert('è«‹å¡«å¯«ï¼šç·¨è™Ÿã€æ¡ˆå');
        return;
      }

      try {
        await saveProject(body);
        closeModal();
        // è‹¥æ˜¯ createï¼Œæ¸…ç©ºæ¬„ä½
        if(mode !== 'edit'){
          ['f_project_id','f_name','f_start_date','f_estimated_days'].forEach(id => document.getElementById(id).value = '');
          document.getElementById('f_stage').value = '0';
          document.getElementById('f_responsible_user').value = '';
          updateDuePreview();
        }
      } catch (e) {
        console.error('[SAVE] failed', e);
        alert('æ“ä½œå¤±æ•—ï¼š' + (e?.message || e));
      }
    });
  </script>
</body>
</html>
