<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç™»å…¥å¾Œé é¢</title>

  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

  <link rel="stylesheet" href="/assets/css/app.css?v=20251106">
  <link rel="stylesheet" href="/assets/css/pages/home.css?v=20251106">
  
</head>
<body>
  
  <div class="app">
    <!-- å·¦å´ Sidebarï¼šå¸³è™Ÿã€ç™»å‡ºã€é¸å–® -->
    <aside class="sidebar">
      <div class="account">
        <div>
          <div class="name" id="accountName">ä½¿ç”¨è€…åç¨±</div>
          <div class="role" id="accountRole">å·²ç™»å…¥</div>
        </div>
        <button id="logoutBtn" class="logout-btn">ç™»å‡º</button>
      </div>
      <ul class="nav">
        <li><button class="active" data-view="projects">å°ˆæ¡ˆé€²åº¦</button></li>
        <li><button data-view="password">ä¿®æ”¹å¯†ç¢¼</button></li>
      </ul>
    </aside>

    <!-- å³å´ Main -->
    <main class="main">
      <!-- é é¢é ‚ç«¯æ¨™é¡Œåˆ— -->
      <div class="topbar">
        <div class="title" id="pageTitle">æ‰€æœ‰å°ˆæ¡ˆé€²åº¦</div>
      </div>

      <section class="content">
        <!-- å°ˆæ¡ˆé€²åº¦ View -->
        <div id="view-projects" class="view">
          <div class="card">

            <!-- é ç°½ï¼šé€²è¡Œä¸­ï¼å·²å®Œæˆï¼å…¨éƒ¨ -->
            <div class="tabs-row" role="tablist" aria-label="å°ˆæ¡ˆç¯©é¸">
              <button class="tab" role="tab" data-filter="ongoing" aria-selected="true">é€²è¡Œä¸­</button>
              <button class="tab" role="tab" data-filter="done" aria-selected="false">å·²å®Œæˆ</button>
              <button class="tab" role="tab" data-filter="all" aria-selected="false">å…¨éƒ¨</button>
            </div>

            <!-- å·¥å…·åˆ—ï¼šå·¦ç‹€æ…‹èªªæ˜ + å³åŠŸèƒ½æŒ‰éˆ• -->
            <div class="card-topbar">

              <div class="legend" id="legendBar">
                <span class="pill"><i class="dot ok"></i>æ­£å¸¸</span>
                <span class="pill"><i class="dot warn"></i>è¼•å¾®è¶…æ™‚</span>
                <span class="pill"><i class="dot danger"></i>è¶…æ™‚7å¤©</span>
                <span class="pill"><i class="dot done"></i>å®Œæˆ(ä¸Šå‚³ç…§ç‰‡)</span>
              </div>
              <div class="function-buttons">
                <div id="unsavedNotice">
                  âš ï¸ å°šæœªå„²å­˜ä¿®æ”¹ï¼Œè«‹è¨˜å¾—æŒ‰ä¸‹ã€Œå„²å­˜ã€
                </div>
                <div>
                  <button id="addProjectBtn">
                    æ–°å¢
                  </button>
                  <button id="saveBtn">
                    å„²å­˜
                  </button>
                </div>
              </div>
            </div>

            <!-- Grid è¡¨é ­ -->
            <div class="grid-header mode-default" id="gridHeader">
              <div>éšæ®µ</div>
              <div>ç·¨è™Ÿ</div>
              <div>æ¡ˆå</div>
              <!--  8 æ¬„ä½çš„è¡¨é ­åç¨±
              <div>ä¸ˆé‡</div>
              <div>æ¡ˆä¾‹åˆ†æ</div>
              <div>å¹³é¢æ”¾æ¨£</div>
              <div>å¹³é¢åœ–</div>
              <div>å¹³é¢ç³»çµ±åœ–</div>
              <div>ç«‹é¢æ¡†é«”åœ–</div>
              <div>ç«‹é¢åœ–</div>
              <div>æ–½å·¥åœ–</div> -->
              <div class="action-head"></div>
              <div class="action-head"></div>
              <div class="action-head"></div>
            </div>

            <!-- ç”±ç¨‹å¼å‹•æ…‹æ³¨å…¥ -->
            <div id="projectsGrid"></div>
          </div>
        </div>

        <!-- ä¿®æ”¹å¯†ç¢¼ Viewï¼ˆä¿æŒåŸæ¨£ï¼‰ -->
        <div id="view-password" class="view" style="display:none">
          <div class="card">
            <h2>ä¿®æ”¹å¯†ç¢¼</h2>
            <p>è«‹è¼¸å…¥èˆŠå¯†ç¢¼èˆ‡æ–°å¯†ç¢¼ã€‚</p>
            <form id="pwdForm" onsubmit="return false;">
              <div>
                <label>
                  <div>èˆŠå¯†ç¢¼</div>
                  <input type="password" id="oldPwd" placeholder="è¼¸å…¥èˆŠå¯†ç¢¼" required>
                </label>
                <label>
                  <div>æ–°å¯†ç¢¼</div>
                  <input type="password" id="newPwd" placeholder="è‡³å°‘ 6 ç¢¼" required minlength="6">
                </label>
                <label>
                  <div>å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼</div>
                  <input type="password" id="newPwd2" placeholder="å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼" required minlength="6">
                </label>
                <button id="savePwd">å„²å­˜</button>
                <div id="pwdMsg"></div>
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- æ–°å¢/ç·¨è¼¯ å…±ç”¨ Modal  -->
      <div id="createModal" class="modal-overlay">
        <div class="modal">
          <div class="modal-header">
            <h3 class="modal-title">æ–°å¢å°ˆæ¡ˆ</h3>
            <button id="modalCloseBtn" class="modal-close" aria-label="é—œé–‰">&times;</button>
          </div>
          <div class="modal-body">
            <label>ç·¨è™Ÿï¼ˆå¿…å¡«ï¼‰
              <input id="f_project_id" />
            </label>
            <label>æ¡ˆåï¼ˆå¿…å¡«ï¼‰
              <input id="f_name" />
            </label>
            <label>éšæ®µ
              <select id="f_stage">
                <option value="0">ç­‰å¾…</option>
                <option value="1">è¨­è¨ˆ</option>
                <option value="2">æ–½å·¥</option>
              </select>
            </label>
            <label>é–‹å§‹æ—¥
              <input id="f_start_date" type="date" />
            </label>
            <label>å·¥æœŸå¤©æ•¸
              <input id="f_estimated_days" type="number" min="0" step="1" />
            </label>
            <label>è² è²¬äºº
              <select id="f_responsible_user">
                <option value="">ï¼ˆæœªæŒ‡æ´¾ï¼‰</option>
              </select>
            </label>

            <div id="f_due_preview">é è¨ˆå®Œå·¥æ—¥ï¼šâ€”</div>

            <div class="modal-actions">
              <button id="f_cancel">å–æ¶ˆ</button>
              <button id="f_submit">é€å‡º</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>



  <!-- ä¸Šå‚³ç…§ç‰‡ Modal èˆ‡é‚è¼¯ -->
  <input id="uploadInput" type="file" accept="image/*" multiple style="display:none" />

  <div id="uploadModal">
    <div>
      <h3>ä¸Šå‚³ç…§ç‰‡</h3>
      <p id="uploadHint"></p>
      <div>
        <button id="chooseFileBtn">é¸æ“‡æª”æ¡ˆ</button>
        <button id="cancelUploadBtn">å–æ¶ˆ</button>
      </div>
      <div id="uploadStatus"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module" src="/assets/js/pages/home.js?v=20251106"></script>

  <script type="module">
    import { api, toUserMessage } from "/assets/js/api.js";

    (async () => {
      // -------------------------------
      // â‘  å–å¾—ç›®å‰ç™»å…¥è€…ï¼ˆä½¿ç”¨ Cookieï¼‰
      // -------------------------------
      let me = null;
      try {
        me = await api.auth.me();   // â†ğŸ”¥ å°±æ˜¯æ”¾é€™è£¡ï¼
      } catch (err) {
        alert(toUserMessage(err, "ç„¡æ³•å–å¾—ç™»å…¥ç‹€æ…‹"));
      }

      if (!me) {
        // æœªç™»å…¥ â†’ é€€å› login é 
        location.href = "/login.html";
        return;
      }

      // åœ¨ç•«é¢ä¸Šé¡¯ç¤ºç™»å…¥è€…åç¨± + è§’è‰²
      document.getElementById("accountName").textContent = me.username;
      document.getElementById("accountRole").textContent = me.role === "admin" ? "ç³»çµ±ç®¡ç†å“¡" : "ä¸€èˆ¬ä½¿ç”¨è€…";

      // -------------------------------
      // â‘¡ ä½ çš„å…¶å®ƒé é¢åˆå§‹åŒ–ç¨‹å¼ç¢¼
      // -------------------------------
      const params = new URLSearchParams(location.search);
      const projectId = params.get("projectId");

      if (projectId) {
        try {
          const plan = await api.stagePlan.get(projectId);
          console.log("Stage Plan: ", plan);
        } catch (err) {
          alert(toUserMessage(err));
        }
      }
    })();
  </script>



</body>
</html>